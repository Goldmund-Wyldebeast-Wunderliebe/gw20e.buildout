[buildout]
extends = 
    buildout-base.cfg
{% if zeo %}
    includes/zeo.cfg
{% endif %}
    includes/supervisor.cfg
{% if varnish %}
    includes/varnish.cfg
{% endif %}
{% if haproxy %}
    includes/haproxy.cfg
{% endif %}
    includes/crontab.cfg


parts +=
{% for instance, port in instances.ports.items() %}
    {{ instance }}
{% endfor %}



[supervisor]
programs +=
{% for instance, port in instances.ports.items() %}
    20 {{ instance }} ${buildout:directory}/bin/{{ instance }} [console] true
{% endfor %}
{% if varnish %}
    60 varnish ${buildout:directory}/bin/varnish true
{% endif %}
{% if haproxy %}
    70 haproxy ${buildout:directory}/bin/haproxy [-f ${buildout:directory}/etc/haproxy.conf -db] true
{% endif %}


{% if varnish %}
[varnish]
port = {{ varnish.port }}
{% endif %}


{% if haproxy %}
[haproxy-conf]
port = {{ haproxy.port }}

auth-backends =
{% for name, ip in instances.ipaddresses.items() %}
{% for instance, port in instances.ports.items() %}
    server  {{ name }}-{{ instance }} {{ ip }}:{{ port }} cookie {{ name }}-{{ instance }} check inter 2000 maxconn 2 rise 1
{% endfor %}
{% endfor %}

anon-backends = 
    ${:auth-backends}
{% endif %}


[instance]
username = {{ credentials.username }}
password = {{ credentials.password }}
user = {{ credentials.username }}:{{ credentials.password }}


[instance-base]
recipe = collective.recipe.zope2cluster
instance-clone = instance
{% if zeo %}
zeo-client = on
zeo-address = ${zeo:zeo-address}
{% endif %}
{% if sentry %}
event-log-custom =
    %import raven.contrib.zope
    <logfile>
      path ${buildout:directory}/var/log/${:_buildout_section_name_}.log
      level INFO
    </logfile>
    <sentry>
      dsn {{ sentry.dsn }}
      level {{ sentry.level }}
    </sentry>
{% endif %}


{% for instance, port in instances.ports.items() %}
[{{ instance }}]
<= instance-base
http-address = port
{% endfor %}


{% if zeo %}
[zeo]
zeo-address = {{ flyingip }}:{{ zeo.port }}
file-storage = {{ zeo.base }}/filestorage/Data.fs
blob-storage = {{ zeo.base }}/blobstorage
{% endif %}

